<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
<title>House Of Tara — Offline Inventory & POS</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0f5a40">
<style>
  /* MOBILE-FIRST single-column layout */
  :root{
    --brand-deep:#0f5a40;
    --brand-gold:#f0c65a;
    --muted:#6b6b6b;
    --bg:#f6f6f8;
    --card:#ffffff;
    --radius:12px;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;padding:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:var(--bg);-webkit-font-smoothing:antialiased}
  body{display:flex;flex-direction:column;min-height:100vh}

  /* Header - centered */
  header.app-header{
    background:linear-gradient(90deg,var(--brand-deep), #17694f 60%);
    color:white;
    padding:12px;
    display:flex;
    align-items:center;
    gap:10px;
    justify-content:center;
    flex-direction:column;
    text-align:center;
  }
  .header-row{display:flex;align-items:center;gap:12px;justify-content:center;width:100%}
  .hot-logo{width:56px;height:56px;border-radius:10px;object-fit:cover;box-shadow:0 6px 18px rgba(0,0,0,0.18)}
  .app-title{font-size:18px;font-weight:800;margin:6px 0;text-align:center}
  .app-sub{font-size:13px;color:rgba(255,255,255,0.95);margin:0}

  /* Main app container */
  main.app{flex:1;overflow-y:auto;padding:12px;padding-bottom:88px;max-width:720px;margin:0 auto;width:100%}

  /* Cards and forms */
  .card{background:var(--card);border-radius:var(--radius);padding:12px;margin-bottom:12px;box-shadow:0 6px 18px rgba(0,0,0,0.05)}
  h3{margin:0 0 8px 0;font-size:16px}
  label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
  input,select,textarea,button{font-size:14px;padding:10px;border-radius:8px;border:1px solid #e8e8e8;width:100%}
  .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  .btn{background:var(--brand-deep);color:#fff;border:none;padding:10px;border-radius:8px;cursor:pointer}
  .btn.secondary{background:#efefef;color:#222}

  .small{font-size:13px;color:var(--muted)}
  .center{text-align:center}

  /* Inventory list/table */
  .inv-list{margin-top:8px}
  .table-responsive{overflow:auto}
  table{width:100%;border-collapse:collapse;font-size:13px}
  th,td{padding:10px 8px;border-bottom:1px solid #f2f2f2;text-align:left}

  /* Sale rows */
  .sale-rows{display:flex;flex-direction:column;gap:8px}
  .sale-row{display:flex;flex-direction:column;gap:8px}
  .sale-row .h{display:flex;gap:8px}
  .sale-row .h input{flex:1}
  .sale-total{display:flex;justify-content:space-between;align-items:center;margin-top:8px;font-weight:700}

  /* Labels */
  .label-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
  .label-sheet{padding:8px;border-radius:8px}

  /* Top tabs (hidden on narrow screens) */
  .tabs{display:none;gap:8px;flex-wrap:wrap;justify-content:center;padding:10px 0}
  .tabs button{background:var(--card);border-radius:10px;padding:8px 10px;border:1px solid rgba(0,0,0,0.06);font-weight:700}

  /* Bottom navigation (mobile) */
  nav.bottom-nav{position:fixed;bottom:0;left:0;right:0;height:64px;background:#fff;display:flex;justify-content:space-around;align-items:center;border-top:1px solid #e6e6e6;z-index:999}
  nav.bottom-nav button{background:none;border:none;flex:1;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:11px;color:#333;cursor:pointer}
  nav.bottom-nav button span{display:block;margin-top:4px}
  nav.bottom-nav button.active{color:var(--brand-deep);font-weight:700}

  /* Slightly larger screens: show top tabs and hide bottom nav */
  @media(min-width:740px){
    .tabs{display:flex}
    nav.bottom-nav{display:none}
    main.app{padding-bottom:20px}
  }

  /* Extra narrow screen tweaks */
  @media(max-width:360px){
    .hot-logo{width:48px;height:48px}
    header.app-header{padding:10px}
    .btn{font-size:13px;padding:10px}
  }

  /* Printing */
  @media print{
    nav.bottom-nav {display:none}
  }
</style>
</head>
<body>

<header class="app-header">
  <div class="header-row">
    <img src="icons/icon-192.png" alt="HOT" class="hot-logo" />
    <div style="display:flex;flex-direction:column;justify-content:center;margin-left:8px">
      <div class="app-title">House Of Tara</div>
      <div class="app-sub">Offline Inventory & POS</div>
    </div>
  </div>
</header>

<main class="app">

  <!-- top tabs (hidden on phones, helpful on larger screens) -->
  <div class="tabs">
    <button id="tab-inventory">Inventory</button>
    <button id="tab-check">Check</button>
    <button id="tab-sale">Sale</button>
    <button id="tab-viewsales">Sales</button>
    <button id="tab-labels">Labels</button>
    <button id="tab-data">Data</button>
  </div>

  <!-- Inventory -->
  <section id="section-inventory" class="card">
    <h3>Add / Edit Inventory</h3>
    <form id="form-inv" autocomplete="off">
      <label>Product Name</label>
      <input id="p-name" required />

      <label style="margin-top:8px">SKU</label>
      <input id="p-sku" required />

      <div style="display:flex;gap:8px;margin-top:8px">
        <div style="flex:1">
          <label>Cost Price</label>
          <input id="p-cost" type="number" step="0.01" />
        </div>
        <div style="width:120px">
          <label>Stock</label>
          <input id="p-stock" type="number" step="1" value="0" />
        </div>
      </div>

      <label style="margin-top:8px">Selling Price</label>
      <input id="p-sell" type="number" step="0.01" />

      <div class="controls">
        <button class="btn" type="submit">Save Item</button>
        <button class="btn secondary" type="button" id="inv-clear">Clear Form</button>
      </div>
    </form>

    <div class="card" style="margin-top:12px;padding:10px">
      <div class="small">Inventory List (select items to generate labels)</div>
      <div id="inv-list" class="inv-list" style="margin-top:8px">No items yet.</div>
    </div>
  </section>

  <!-- Check Inventory -->
  <section id="section-check" class="card" style="display:none">
    <h3>Check Inventory</h3>
    <label class="small">Search by Name or SKU</label>
    <input id="search-inv" placeholder="Type name or SKU" style="margin-top:6px">
    <div class="card" style="margin-top:10px;padding:8px">
      <div class="table-responsive">
        <table><thead><tr><th>SKU</th><th>Name</th><th>Stock</th><th>Cost</th><th>Selling</th></tr></thead><tbody id="table-check"></tbody></table>
      </div>
    </div>
  </section>

  <!-- Sale / POS -->
  <section id="section-sale" class="card" style="display:none">
    <h3>Sale</h3>
    <label class="small">Customer Name (optional)</label>
    <input id="sale-cust" placeholder="Customer name" style="margin-top:6px">

    <div style="margin-top:10px">
      <div id="sale-rows" class="sale-rows"></div>

      <div class="controls" style="margin-top:8px">
        <button class="btn" id="add-sale-row" type="button">Add Product Row</button>
        <button class="btn secondary" id="clear-sale" type="button">Clear Rows</button>
      </div>

      <div class="sale-total">
        <div>Total: ₹ <span id="sale-total">0.00</span></div>
        <div><button class="btn" id="submit-sale">Submit Sale</button></div>
      </div>
    </div>
  </section>

  <!-- View Sales -->
  <section id="section-viewsales" class="card" style="display:none">
    <h3>View Sales</h3>
    <div id="sales-list" class="small">No sales yet.</div>
  </section>

  <!-- Labels -->
  <section id="section-labels" class="card" style="display:none">
    <h3>Labels</h3>
    <div class="small">Select inventory items then create labels (24 per A4 sheet).</div>
    <div class="controls" style="margin-top:8px">
      <button class="btn" id="create-labels">Create Labels</button>
      <button class="btn secondary" id="clear-selection">Clear Selection</button>
    </div>
    <div id="labels-output" style="margin-top:12px"></div>
  </section>

  <!-- Data -->
  <section id="section-data" class="card" style="display:none">
    <h3>Data — Export / Import / Migrate</h3>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn" id="export-inv">Export Inventory (JSON)</button>
      <button class="btn" id="export-sales">Export Sales (JSON)</button>
      <label class="btn secondary" style="cursor:pointer"><input id="import-file" type="file" accept=".json" style="display:none"> Import JSON</label>
      <button class="btn secondary" id="migrate">Migrate from localStorage</button>
    </div>
    <div id="data-msg" style="margin-top:12px"></div>
  </section>

</main>

<!-- Bottom navigation -->
<nav class="bottom-nav" role="navigation">
  <button data-tab="inv" class="active">Inventory</button>
  <button data-tab="check">Check</button>
  <button data-tab="sale">Sale</button>
  <button data-tab="viewsales">Sales</button>
  <button data-tab="labels">Labels</button>
  <button data-tab="data">Data</button>
</nav>

<script>
/* ---------------- IndexedDB wrapper ---------------- */
const DB_NAME = 'hot_db_v1';
const DB_VERSION = 1;
const STORE_INV = 'inventory';
const STORE_SALES = 'sales';

function openDB(){
  return new Promise((resolve, reject) => {
    const req = indexedDB.open(DB_NAME, DB_VERSION);
    req.onupgradeneeded = (e) => {
      const db = e.target.result;
      if(!db.objectStoreNames.contains(STORE_INV)){
        const s = db.createObjectStore(STORE_INV, { keyPath: 'sku' });
        s.createIndex('name', 'name', { unique: false });
      }
      if(!db.objectStoreNames.contains(STORE_SALES)){
        db.createObjectStore(STORE_SALES, { keyPath: 'id' });
      }
    };
    req.onsuccess = () => resolve(req.result);
    req.onerror = () => reject(req.error);
  });
}
async function idbPut(store, value){
  const db = await openDB();
  return new Promise((res, rej)=>{
    const tx = db.transaction(store, 'readwrite');
    tx.objectStore(store).put(value);
    tx.oncomplete = ()=>res(true);
    tx.onerror = ()=>rej(tx.error);
  });
}
async function idbGetAll(store){
  const db = await openDB();
  return new Promise((res, rej)=>{
    const tx = db.transaction(store, 'readonly');
    const req = tx.objectStore(store).getAll();
    req.onsuccess = ()=>res(req.result);
    req.onerror = ()=>rej(req.error);
  });
}
async function idbGet(store, key){
  const db = await openDB();
  return new Promise((res, rej)=>{
    const tx = db.transaction(store, 'readonly');
    const req = tx.objectStore(store).get(key);
    req.onsuccess = ()=>res(req.result);
    req.onerror = ()=>rej(req.error);
  });
}
async function idbDelete(store, key){
  const db = await openDB();
  return new Promise((res, rej)=>{
    const tx = db.transaction(store, 'readwrite');
    tx.objectStore(store).delete(key);
    tx.oncomplete = ()=>res(true);
    tx.onerror = ()=>rej(tx.error);
  });
}

/* ---------------- App logic ---------------- */
async function saveInvItem(item){
  await idbPut(STORE_INV, item);
  await renderInvList();
  await renderCheckTable();
}
async function deleteInvSku(sku){
  await idbDelete(STORE_INV, sku);
  await renderInvList();
  await renderCheckTable();
}
async function getAllInventory(){ return await idbGetAll(STORE_INV); }
async function getAllSales(){ return await idbGetAll(STORE_SALES); }
async function saveSale(entry){
  await idbPut(STORE_SALES, entry);
  // reduce stock
  for(const it of entry.items){
    const inv = await idbGet(STORE_INV, it.sku);
    if(inv){ inv.stock = Math.max(0, (parseInt(inv.stock)||0) - it.qty); await idbPut(STORE_INV, inv); }
  }
  await renderInvList();
  await renderSalesList();
}

/* ---------------- UI: Sections & Nav ---------------- */
const sections = {
  inv: document.getElementById('section-inventory'),
  check: document.getElementById('section-check'),
  sale: document.getElementById('section-sale'),
  viewsales: document.getElementById('section-viewsales'),
  labels: document.getElementById('section-labels'),
  data: document.getElementById('section-data')
};
function showSection(key){
  Object.values(sections).forEach(s => s.style.display = 'none');
  const el = sections[key];
  if(el) el.style.display = 'block';
  document.querySelectorAll('nav.bottom-nav button').forEach(b => b.classList.remove('active'));
  const btn = document.querySelector(`nav.bottom-nav button[data-tab="${key}"]`);
  if(btn) btn.classList.add('active');
  window.scrollTo({top:0,behavior:'smooth'});
}
document.querySelectorAll('nav.bottom-nav button').forEach(b => b.addEventListener('click', ()=> showSection(b.dataset.tab)));
const mapTop = {
  'tab-inventory': 'inv',
  'tab-check': 'check',
  'tab-sale': 'sale',
  'tab-viewsales': 'viewsales',
  'tab-labels': 'labels',
  'tab-data': 'data'
};
Object.keys(mapTop).forEach(id => {
  const el = document.getElementById(id);
  if(el) el.addEventListener('click', ()=> showSection(mapTop[id]));
});

/* ---------------- Inventory form ---------------- */
document.getElementById('form-inv').onsubmit = async function(e){
  e.preventDefault();
  const name = document.getElementById('p-name').value.trim();
  const sku = document.getElementById('p-sku').value.trim();
  const cost = parseFloat(document.getElementById('p-cost').value)||0;
  const sell = parseFloat(document.getElementById('p-sell').value)||0;
  const stock = parseInt(document.getElementById('p-stock').value)||0;
  if(!name||!sku){ alert('Name and SKU required'); return; }
  await saveInvItem({name,sku,cost,sell,stock});
  this.reset();
};
document.getElementById('inv-clear').onclick = ()=> document.getElementById('form-inv').reset();

/* ---------------- Render inventory list ---------------- */
async function renderInvList(){
  const inventory = await getAllInventory();
  const container = document.getElementById('inv-list');
  if(!inventory || !inventory.length){ container.innerHTML = '<div class="center small">No items yet.</div>'; return; }
  let html = '<div class="table-responsive"><table><thead><tr><th></th><th>SKU</th><th>Name</th><th>Stock</th><th>Cost</th><th>Selling</th><th>Actions</th></tr></thead><tbody>';
  inventory.forEach(it=>{
    html += `<tr><td><input data-sku="${it.sku}" type="checkbox" class="label-checkbox" /></td><td>${it.sku}</td><td>${it.name}</td><td>${it.stock}</td><td>${it.cost}</td><td>${it.sell}</td><td><button data-sku="${it.sku}" class="edit-item">Edit</button> <button data-sku="${it.sku}" class="del-item">Delete</button></td></tr>`;
  });
  html += '</tbody></table></div>';
  container.innerHTML = html;
  container.querySelectorAll('.edit-item').forEach(b=>b.addEventListener('click', async (e)=>{
    const sku = e.target.dataset.sku;
    const it = await idbGet(STORE_INV, sku);
    if(it){
      document.getElementById('p-name').value = it.name;
      document.getElementById('p-sku').value = it.sku;
      document.getElementById('p-cost').value = it.cost;
      document.getElementById('p-sell').value = it.sell;
      document.getElementById('p-stock').value = it.stock;
      showSection('inv');
    }
  }));
  container.querySelectorAll('.del-item').forEach(b=>b.addEventListener('click', async (e)=>{
    const sku = e.target.dataset.sku;
    if(confirm('Delete this item?')){ await deleteInvSku(sku); }
  }));
}

/* ---------------- Check table ---------------- */
async function renderCheckTable(filter=''){
  const tbody = document.getElementById('table-check');
  tbody.innerHTML = '';
  const q = (filter||'').trim().toLowerCase();
  const inventory = await getAllInventory();
  (inventory||[]).filter(it=>!q || it.name.toLowerCase().includes(q) || it.sku.toLowerCase().includes(q)).forEach(it=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${it.sku}</td><td>${it.name}</td><td>${it.stock}</td><td>${it.cost}</td><td>${it.sell}</td>`;
    tbody.appendChild(tr);
  });
}
document.getElementById('search-inv').addEventListener('input', e => renderCheckTable(e.target.value));

/* ---------------- Labels ---------------- */
function getSelectedForLabels(){ return Array.from(document.querySelectorAll('.label-checkbox')).filter(c=>c.checked).map(c=>c.dataset.sku); }
document.getElementById('create-labels').addEventListener('click', async ()=>{
  const selectedSkus = getSelectedForLabels();
  if(!selectedSkus.length){ alert('Select items from Inventory list first'); return; }
  const out = document.getElementById('labels-output'); out.innerHTML = '';
  const items = await Promise.all(selectedSkus.map(sku => idbGet(STORE_INV, sku)));
  const perPage = 24;
  for(let p=0;p<Math.ceil(items.length/perPage);p++){
    const pageItems = items.slice(p*perPage, (p+1)*perPage);
    const sheet = document.createElement('div'); sheet.className = 'label-sheet card';
    const grid = document.createElement('div'); grid.className = 'label-grid';
    for(let i=0;i<perPage;i++){
      const cell = document.createElement('div'); cell.className = 'label-cell';
      const it = pageItems[i];
      if(it){
        const name = document.createElement('div'); name.textContent = it.name; name.style.fontSize='12px'; name.style.fontWeight='600'; name.style.marginBottom='6px';
        const canvas = document.createElement('canvas'); canvas.width = 300; canvas.height = 80; canvas.style.width = '100%';
        const skuText = document.createElement('div'); skuText.textContent = it.sku; skuText.style.fontSize='11px'; skuText.style.marginTop='6px';
        cell.appendChild(name); cell.appendChild(canvas); cell.appendChild(skuText);
        try{ if(window.JsBarcode){ JsBarcode(canvas, it.sku, {format:"CODE128",displayValue:false,height:40}); } else renderFallbackBarcode(canvas,it.sku); } catch(e){ renderFallbackBarcode(canvas,it.sku); }
      }
      grid.appendChild(cell);
    }
    sheet.appendChild(grid); out.appendChild(sheet);
  }
  setTimeout(()=>window.print(), 600);
});
document.getElementById('clear-selection').addEventListener('click', ()=>document.querySelectorAll('.label-checkbox').forEach(c=>c.checked = false));
function renderFallbackBarcode(canvas, text){ const ctx = canvas.getContext('2d'); ctx.fillStyle='#fff'; ctx.fillRect(0,0,canvas.width,canvas.height); ctx.fillStyle='#000'; const w = canvas.width; const h = canvas.height; const seed = text.split('').reduce((a,c)=>a + c.charCodeAt(0),0); let x=4; for(let i=0;i<text.length;i++){ const ch = text.charCodeAt(i); const stripe = (ch + seed) % 6 + 1; ctx.fillRect(x,4,stripe, h-12); x += stripe + 2; if(x> w-10) break; } }

/* ---------------- Sales UI ---------------- */
const saleRowsContainer = document.getElementById('sale-rows');
function recalcSaleTotal(){ let total=0; document.querySelectorAll('.sale-row').forEach(r=>{ const qty = +r.querySelector('.sale-qty').value || 0; const price = parseFloat(r.querySelector('.sale-price').value) || 0; total += qty * price; }); document.getElementById('sale-total').textContent = total.toFixed(2); }

function addSaleRow(){
  const div = document.createElement('div'); div.className = 'sale-row card';
  div.innerHTML = `
    <div class="h"><input class="sale-sku" placeholder="SKU" /></div>
    <div><input class="sale-name" placeholder="Product name" readonly /></div>
    <div class="h"><input class="sale-qty" type="number" value="1" class="sale-qty" /><input class="sale-price" type="number" step="0.01" class="sale-price" /></div>
    <div style="display:flex;gap:8px"><button class="btn secondary sale-del" type="button">Delete</button></div>
  `;
  saleRowsContainer.appendChild(div);
  const skuInput = div.querySelector('.sale-sku'); const nameInput = div.querySelector('.sale-name'); const qtyInput = div.querySelector('.sale-qty'); const priceInput = div.querySelector('.sale-price');
  skuInput.addEventListener('change', async e=>{ const sku = e.target.value.trim(); const found = await idbGet(STORE_INV, sku); if(found){ nameInput.value = found.name; priceInput.value = found.sell; } else nameInput.value=''; recalcSaleTotal(); });
  priceInput.addEventListener('input', recalcSaleTotal); qtyInput.addEventListener('input', recalcSaleTotal);
  div.querySelector('.sale-del').addEventListener('click', ()=>{ div.remove(); recalcSaleTotal(); });
  recalcSaleTotal();
}
document.getElementById('add-sale-row').addEventListener('click', ()=> addSaleRow());
document.getElementById('clear-sale').addEventListener('click', ()=> { saleRowsContainer.innerHTML=''; recalcSaleTotal(); });

/* ---------------- Submit sale ---------------- */
document.getElementById('submit-sale').addEventListener('click', async ()=>{
  const rows = Array.from(document.querySelectorAll('.sale-row'));
  if(!rows.length){ alert('Add at least one product'); return; }
  const entry = { id: 'S' + Date.now(), customer: document.getElementById('sale-cust').value.trim(), createdAt: new Date().toISOString(), items: [], total:0 };
  for(const r of rows){
    const sku = r.querySelector('.sale-sku').value.trim();
    const name = r.querySelector('.sale-name').value.trim();
    const qty = parseInt(r.querySelector('.sale-qty').value)||0;
    const price = parseFloat(r.querySelector('.sale-price').value)||0;
    if(!sku||!name||qty<=0) continue;
    const inv = await idbGet(STORE_INV, sku);
    const cost = inv ? parseFloat(inv.cost) : 0;
    entry.items.push({sku,name,qty,price,cost});
    entry.total += qty * price;
  }
  await saveSale(entry);
  const w = window.open('','_blank'); const now = new Date(entry.createdAt);
  let billHtml = `<html><head><title>Bill ${entry.id}</title><style>body{font-family:Arial;padding:12px}table{width:100%;border-collapse:collapse}td,th{padding:6px;border-bottom:1px solid #ddd}</style></head><body>`;
  billHtml += `<h3>House Of Tara</h3><div>Sale ID: ${entry.id}</div><div>Date: ${now.toLocaleString()}</div><div>Customer: ${entry.customer||'--'}</div><table><thead><tr><th>SKU</th><th>Item</th><th>Qty</th><th>Rate</th><th>Amount</th></tr></thead><tbody>`;
  entry.items.forEach(it=>{ billHtml += `<tr><td>${it.sku}</td><td>${it.name}</td><td>${it.qty}</td><td>${it.price.toFixed(2)}</td><td>${(it.qty*it.price).toFixed(2)}</td></tr>` });
  billHtml += `</tbody></table><h4>Total: ₹ ${entry.total.toFixed(2)}</h4><div>Thank you for shopping with House Of Tara</div></body></html>`;
  w.document.write(billHtml); w.document.close(); w.print();
  document.getElementById('sale-cust').value=''; saleRowsContainer.innerHTML=''; recalcSaleTotal();
});

/* ---------------- View sales ---------------- */
async function renderSalesList(){
  const container = document.getElementById('sales-list');
  const sales = await getAllSales();
  if(!sales || !sales.length){ container.innerHTML = '<div class="center small">No sales yet.</div>'; return; }
  let html = '<div class="table-responsive"><table><thead><tr><th>Sale ID</th><th>Date</th><th>Items</th><th>Total</th><th>Profit</th></tr></thead><tbody>';
  sales.slice().reverse().forEach(s=>{
    const date = new Date(s.createdAt).toLocaleString();
    const items = s.items.map(it=>`${it.name} (${it.sku}) x${it.qty}`).join('<br>');
    const profit = s.items.reduce((a,it)=> a + ( (it.price - it.cost) * it.qty ),0);
    html += `<tr><td>${s.id}</td><td>${date}</td><td>${items}</td><td>₹ ${s.total.toFixed(2)}</td><td>₹ ${profit.toFixed(2)}</td></tr>`;
  });
  html += '</tbody></table></div>';
  container.innerHTML = html;
}

/* ---------------- Export / Import / Migrate ---------------- */
function escapeHtmlForPre(s){ return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

async function download(filename, content){
  try {
    const blob = new Blob([content], { type: 'application/json' });

    if (window.showSaveFilePicker) {
      try {
        const opts = { suggestedName: filename, types: [{ description: 'JSON', accept: {'application/json': ['.json']} }] };
        const handle = await window.showSaveFilePicker(opts);
        const writable = await handle.createWritable();
        await writable.write(blob);
        await writable.close();
        alert('Export saved to your device.');
        return;
      } catch (err) { console.warn('FS API fallback:', err); }
    }

    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = filename; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);

    setTimeout(()=>{
      const isiOS = /iphone|ipad|ipod/i.test(navigator.userAgent);
      const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true;
      if(isiOS && isStandalone){
        const win = window.open();
        if(win){
          win.document.write('<pre>' + escapeHtmlForPre(content) + '</pre>');
          win.document.title = filename;
          alert('Opened JSON in a new window — long-press / save to Files.');
        } else {
          copyToClipboard(content).then(()=> alert('Copied JSON to clipboard — paste into a file.'));
        }
      }
    }, 500);

  } catch (err) {
    console.error('Download failed:', err);
    try { await copyToClipboard(content); alert('Export copied to clipboard. Paste into file.'); } catch(e){ alert('Unable to export automatically. Please copy manually.'); }
  }
}
async function copyToClipboard(text){
  if(navigator.clipboard && navigator.clipboard.writeText) return navigator.clipboard.writeText(text);
  const ta = document.createElement('textarea'); ta.value = text; ta.style.position='fixed'; ta.style.left='-9999px'; document.body.appendChild(ta); ta.focus(); ta.select();
  try { document.execCommand('copy'); document.body.removeChild(ta); return; } catch(e){ document.body.removeChild(ta); throw e; }
}

document.getElementById('export-inv').addEventListener('click', async ()=>{ const inv = await getAllInventory(); download('inventory.json', JSON.stringify(inv,null,2)); });
document.getElementById('export-sales').addEventListener('click', async ()=>{ const s = await getAllSales(); download('sales.json', JSON.stringify(s,null,2)); });

document.getElementById('import-file').addEventListener('change', async (e)=>{
  const f = e.target.files[0]; if(!f) return;
  const txt = await f.text(); try{
    const data = JSON.parse(txt);
    if(Array.isArray(data) && data.length && data[0].sku) { for(const it of data) await idbPut(STORE_INV, it); document.getElementById('data-msg').innerText = 'Imported inventory items.'; }
    else if(Array.isArray(data) && data.length && data[0].id){ for(const s of data) await idbPut(STORE_SALES, s); document.getElementById('data-msg').innerText = 'Imported sales.'; }
    else { document.getElementById('data-msg').innerText = 'Unknown JSON format.'; }
    await renderInvList(); await renderSalesList(); await renderCheckTable();
  }catch(err){ document.getElementById('data-msg').innerText = 'Invalid JSON file.'; }
});

document.getElementById('migrate').addEventListener('click', async ()=>{
  const invRaw = localStorage.getItem('hot_inv_items_v1');
  const salesRaw = localStorage.getItem('hot_sales_v1');
  let migrated = 0;
  if(invRaw){ try{ const inv = JSON.parse(invRaw); for(const it of inv){ await idbPut(STORE_INV, it); migrated++; } }catch(e){} }
  if(salesRaw){ try{ const s = JSON.parse(salesRaw); for(const sale of s){ await idbPut(STORE_SALES, sale); migrated++; } }catch(e){} }
  document.getElementById('data-msg').innerText = migrated ? ('Migrated ' + migrated + ' records from localStorage.') : 'No localStorage data found to migrate.';
  await renderInvList(); await renderSalesList(); await renderCheckTable();
});

/* ---------------- Service worker ---------------- */
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('service-worker.js').then(()=>console.log('SW registered')).catch(err=>console.warn('SW failed',err));
}

/* ---------------- Init ---------------- */
(async function init(){
  await renderInvList();
  await renderCheckTable();
  await renderSalesList();
  addSaleRow();
  showSection('inv');
})();
</script>

</body>
</html>
